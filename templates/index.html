<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Bit Audio Digit Classifier</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/retro.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1 class="title">Audio Digit Detective</h1>
            <p class="subtitle">Retro-Style Spoken Digit Recognition Challenge</p>
            <p style="font-size: 8px; margin-top: 15px;">
                Speak digits 0-9 and watch AI methods compete! Choose your processor and test accuracy.
            </p>
        </div>

        <!-- Instructions Cabinet -->
        <div class="cabinet">
            <div class="cabinet-header">
                <h2 class="cabinet-title">How to Play</h2>
            </div>
            <div style="font-size: 10px; line-height: 1.6;">
                <p><strong>1.</strong> Click "Start Recording" and clearly say a digit (0-9)</p>
                <p><strong>2.</strong> Select a processing method from the cabinets below</p>
                <p><strong>3.</strong> Watch the real-time audio visualization</p>
                <p><strong>4.</strong> Compare inference times and accuracy across methods</p>
                <p><strong>5.</strong> Add noise to test robustness!</p>
            </div>
        </div>

        <!-- Audio Visualizer Section -->
        <div class="cabinet">
            <div class="cabinet-header">
                <h2 class="cabinet-title">Audio Input Monitor</h2>
            </div>
            <div class="visualizer-container">
                <div class="visualizer-screen">
                    <canvas id="audioCanvas" width="800" height="200"></canvas>
                </div>
                <div class="visualizer-controls">
                    <button id="startRecording" class="btn btn-success">Start Recording</button>
                    <button id="stopRecording" class="btn btn-danger" disabled>Stop Recording</button>
                    <button id="clearCanvas" class="btn btn-info">Clear Screen</button>
                    <div style="margin-left: 20px; font-size: 8px;">
                        <span id="recordingStatus">Ready to record...</span>
                        <br>
                        <span id="audioInfo">Duration: 0.0s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Method Selection -->
        <div class="cabinet">
            <div class="cabinet-header">
                <h2 class="cabinet-title">Processing Methods</h2>
            </div>
            <div class="method-selector">
                <!-- ML MFCC Cabinet (Best Performance) -->
                <div class="radio-cabinet" data-method="ml_mfcc">
                    <input type="radio" name="method" value="ml_mfcc" id="method_ml_mfcc" checked>
                    <label for="method_ml_mfcc" class="radio-label">ML MFCC + Dense NN</label>
                    <p class="radio-description">Trained ML model: 98.52% accuracy, ~1-2ms inference (Best Performance)</p>
                    <div class="status-indicator {% if processor_status.ml_mfcc.configured %}ready{% else %}error{% endif %}"></div>
                </div>

                <!-- ML Mel CNN Cabinet -->
                <div class="radio-cabinet" data-method="ml_mel_cnn">
                    <input type="radio" name="method" value="ml_mel_cnn" id="method_ml_mel_cnn">
                    <label for="method_ml_mel_cnn" class="radio-label">ML Mel CNN (2D)</label>
                    <p class="radio-description">Trained 2D CNN model: 97.22% accuracy, ~3-5ms inference (Good Performance)</p>
                    <div class="status-indicator {% if processor_status.ml_mel_cnn.configured %}ready{% else %}error{% endif %}"></div>
                </div>

                <!-- ML Raw CNN Cabinet -->
                <div class="radio-cabinet" data-method="ml_raw_cnn">
                    <input type="radio" name="method" value="ml_raw_cnn" id="method_ml_raw_cnn">
                    <label for="method_ml_raw_cnn" class="radio-label">ML Raw CNN (1D)</label>
                    <p class="radio-description">Trained 1D CNN model: 91.30% accuracy, ~5-8ms inference (Fair Performance)</p>
                    <div class="status-indicator {% if processor_status.ml_raw_cnn.configured %}ready{% else %}error{% endif %}"></div>
                </div>

                <!-- External API Cabinet -->
                <div class="radio-cabinet" data-method="wav2vec2">
                    <input type="radio" name="method" value="wav2vec2" id="method_wav2vec2">
                    <label for="method_wav2vec2" class="radio-label">Wav2Vec2 API</label>
                    <p class="radio-description">Facebook's Wav2Vec2 model via Hugging Face API (External)</p>
                    <div class="status-indicator {% if processor_status.wav2vec2.configured %}ready{% else %}warning{% endif %}"></div>
                </div>

                <!-- Legacy Methods (Comparison) -->
                <div class="radio-cabinet" data-method="mfcc" style="opacity: 0.6;">
                    <input type="radio" name="method" value="mfcc" id="method_mfcc">
                    <label for="method_mfcc" class="radio-label">Legacy MFCC</label>
                    <p class="radio-description">Traditional MFCC features (Placeholder - for comparison only)</p>
                    <div class="status-indicator"></div>
                </div>

                <div class="radio-cabinet" data-method="mel_spectrogram" style="opacity: 0.6;">
                    <input type="radio" name="method" value="mel_spectrogram" id="method_mel_spectrogram">
                    <label for="method_mel_spectrogram" class="radio-label">Legacy Mel Spec</label>
                    <p class="radio-description">Traditional Mel spectrogram (Placeholder - for comparison only)</p>
                    <div class="status-indicator"></div>
                </div>
            </div>
        </div>

        <!-- Noise Injection Controls -->
        <div class="cabinet">
            <div class="cabinet-header">
                <h2 class="cabinet-title">Robustness Testing</h2>
            </div>
            <div class="noise-controls">
                <div class="control-group">
                    <label for="noiseType" class="control-label">Noise Type</label>
                    <select id="noiseType" name="noiseType">
                        <option value="none">No Noise</option>
                        <option value="white">White Noise</option>
                        <option value="pink">Pink Noise</option>
                        <option value="brown">Brown Noise</option>
                        <option value="background">Background Noise</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="noiseLevel" class="control-label">Noise Level: <span id="noiseLevelValue">0.0</span></label>
                    <input type="range" id="noiseLevel" name="noiseLevel" min="0" max="0.5" step="0.05" value="0" class="slider">
                </div>
                <div style="font-size: 8px; margin-top: 10px; opacity: 0.7;">
                    Add noise to test robustness of digit recognition methods
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div class="cabinet">
            <div class="cabinet-header">
                <h2 class="cabinet-title">Prediction Results</h2>
            </div>
            <div class="results-container">
                <div class="result-display">
                    <div class="prediction-result">
                        <span style="font-size: 14px;">Predicted Digit: </span>
                        <span id="predictedDigit" style="font-size: 32px; color: #ffe66d;">?</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Method</div>
                            <div class="stat-value" id="methodUsed">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Inference Time</div>
                            <div class="stat-value" id="inferenceTime">0.000s</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Audio Duration</div>
                            <div class="stat-value" id="audioDuration">0.000s</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Average Time</div>
                            <div class="stat-value" id="averageTime">0.000s</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <button id="processAudio" class="btn" disabled>Analyze Audio</button>
                    <button id="getStats" class="btn btn-info" style="margin-left: 10px;">View Stats</button>
                    <button id="testConnection" class="btn btn-info" style="margin-left: 10px;">Test API</button>
                </div>
            </div>
        </div>

        <!-- Live Activity Log -->
        <div class="cabinet">
            <div class="cabinet-header">
                <h2 class="cabinet-title">Activity Log</h2>
            </div>
            <div class="log-container" id="activityLog">
                <div class="log-entry log-info">[INFO] Audio Digit Classifier initialized - Ready for input</div>
                <div class="log-entry log-info">[INFO] Select a processing method and start recording</div>
            </div>
        </div>

        <!-- Performance Comparison -->
        <div class="cabinet">
            <div class="cabinet-header">
                <h2 class="cabinet-title">Performance Monitor</h2>
            </div>
            <div id="performanceStats" class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Total Predictions</div>
                    <div class="stat-value" id="totalPredictions">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Fastest Method</div>
                    <div class="stat-value" id="fastestMethod">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Last Success Rate</div>
                    <div class="stat-value" id="successRate">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Session Time</div>
                    <div class="stat-value" id="sessionTime">00:00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="{{ url_for('static', filename='js/audio-recorder.js') }}"></script>
    <script src="{{ url_for('static', filename='js/audio-visualizer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/noise-generator.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- Initialize Application -->
    <script>
        // Initialize global variables
        window.APP_CONFIG = {
            maxDuration: 10,
            sampleRate: 16000,
            processorStatus: {{ processor_status | tojson | safe }},
            startTime: Date.now()
        };
        
        // Start session timer
        function updateSessionTime() {
            const elapsed = Math.floor((Date.now() - window.APP_CONFIG.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sessionTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        setInterval(updateSessionTime, 1000);
        
        // Log initial processor status
        const processorStatus = {{ processor_status | tojson | safe }};
        if (processorStatus && typeof processorStatus === 'object') {
            for (const [method, status] of Object.entries(processorStatus)) {
                if (status && typeof status === 'object') {
                    const logLevel = status.configured ? 'success' : 'warning';
                    const message = status.configured ? 'Ready' : 'Not configured';
                    addLogEntry(`[${logLevel.toUpperCase()}] ${status.method}: ${message}`, logLevel);
                }
            }
        }
    </script>
</body>
</html>